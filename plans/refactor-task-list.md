# 重构任务清单（基于当前改进方案）

## R0 已完成（本轮已落地）
- [x] 代码先推送到 GitHub 备份（`origin/main`）
- [x] 引入本地文件持久化仓储（Incident / Debate / Report），默认启用 `file` 模式
- [x] 清理运行配置中的 OpenCode 历史残留，统一为 `LLM_*` 环境变量

## R1 架构与编排（P0）
- [ ] 将当前串行编排重构为“并行分析 + 顺序裁决”执行图（Log/Domain/Code 并行）
- [ ] 引入可恢复任务状态机（pending/running/waiting/retrying/completed/failed/cancelled）
- [ ] 统一事件模型（event_id, trace_id, phase, agent, payload_version）
- [ ] 增加任务中断与恢复能力（WebSocket 断开后可继续/重连恢复）

## R2 LLM 调用稳定性（P0）
- [ ] 增加调用级重试策略（幂等重试、指数退避、抖动）
- [ ] 增加超时分层（连接超时、请求超时、总流程超时）
- [ ] 增加结构化输出兜底（JSON 修复器 + 二次格式化提示）
- [ ] 增加 token 预算控制（不同 agent 上下文裁剪策略）

## R3 责任田与资产链路（P1）
- [ ] 责任田映射结果在报告中强制落表展示（领域/聚合根/代码/表/设计引用）
- [ ] 责任田命中失败时给出可执行补充引导（缺少 method/path/trace）
- [ ] 案例检索增加同义词与模糊匹配，降低“误未命中”
- [ ] 资产融合关系支持反向追溯（从表/类反查接口）

## R4 前端体验与可观测性（P1）
- [ ] 流式事件面板支持按 agent/phase/type 过滤与检索
- [ ] 报告页增加结构化卡片视图与高亮差异，不再以长文本为主
- [ ] 历史页支持“分析中任务”进入详情页并实时查看
- [ ] 增加前端 trace 展示（每次 LLM 请求的 trace_id、耗时、状态）

## R5 工程化与质量（P1）
- [ ] 增加真实 LLM 小样本回归集（非 mock），覆盖主链路
- [ ] 增加端到端自动化（创建事件 -> WS 辩论 -> 报告 -> 责任田验证）
- [ ] 文档统一术语（AutoGen / LLM），移除 OpenCode/Claude 历史描述
- [ ] 补充本地数据迁移与清理脚本（file store 版本化）

## 本轮后续执行顺序
1. 先做 R1.1（并行分析编排）和 R2.3（结构化输出兜底）
2. 再做 R4.1（前端过程过滤）保证用户可观测
3. 最后补 R5（测试与文档收敛）
